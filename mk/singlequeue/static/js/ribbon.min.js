function ribbon_change(obj){console.log("from IS form: ",obj)}var ribbonListener=function(){var ribbonReqObj={};function rebuildRibbonState($rbWrapper){var $filter=$rbWrapper.find("[data-isFilter=true]");ribbonReqObj={};return filtersCollection($filter)}function handleMultiSelect($multiSelect){if($multiSelect.data("title")!==null||$multiSelect.data("title")!==undefined){ribbonReqObj[$multiSelect.data("title")]=[]}else{console.log("Undefined filter title")}$multiSelect.next().find(".ms-drop li").each(function(){var $li=$(this);var option={};option.isSelected=function(){if($li.hasClass("selected")){return true}else{return false}}();option.value=$li.find("input").attr("value");option.text=$li.find("label").text();ribbonReqObj[$multiSelect.data("title")].push(option)})}function handleDefaultSelect(defaultSelect){if(defaultSelect.data("title")!==null||defaultSelect.data("title")!==undefined){ribbonReqObj[defaultSelect.data("title")]=[]}else{alert("No Title issue: see ribbon.js ln:48")}defaultSelect.find("option").each(function(){var $option=$(this);var option={};option.text=$option.text();option.value=$option.attr("value");option.isSelected=function(){if($option.attr("selected")){return true}else{return false}}();ribbonReqObj[defaultSelect.data("title")].push(option)})}function handleNoSelectFilters(noSelect){var $prntLi=noSelect.parents("li"),prTitle=$prntLi.data("title");if(prTitle!==null||prTitle!==undefined){if(prTitle in ribbonReqObj){}else{ribbonReqObj[prTitle]=[]}}else{console.log("undefined title!!!")}var option={};option.text=noSelect.find("a span:last-child").text();option.value="no value assigned";option.isSelected=noSelect.hasClass("active-item-bg")?true:false;if(ribbonReqObj[prTitle].length>0){var tempArr=ribbonReqObj[prTitle].filter(function(obj){if(obj.text===option.text){return false}else{return true}});tempArr.push(option);ribbonReqObj[prTitle]=tempArr}else{ribbonReqObj[prTitle].push(option)}}function handleDynamicSelect(fromPopup){var filterTitle=$(fromPopup).find("[data-title]").data("title"),$dynamicSelectElem=$(fromPopup).find(".dynamic-select");if(filterTitle!==null||filterTitle!==undefined){ribbonReqObj[filterTitle]=[]}if($dynamicSelectElem.length>0){$dynamicSelectElem.find("option").each(function(){var $option=$(this);var option={};option.text=$option.text();option.value=$option.attr("value");option.isSelected=true;ribbonReqObj[filterTitle].push(option)})}}var initISfunc={};function getISfunction(funcPassed){initISfunc=function(){var passedFunc=funcPassed;function run(){if(typeof passedFunc!=="undefined"||typeof passedFunc!=="function"){passedFunc(getISobj(ribbonReqObj))}}return{passedFund:passedFunc,run:run}}()}function getISobj(uiObj){var ISribbonObj={},obj=uiObj==undefined?ribbonReqObj:uiObj;function ISobjBuilder(){this.addProperty=function(propertyName,values){ISribbonObj[propertyName]=values};this.fixedPropertyName=function(title,option){String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var fixedTitle="";if(typeof option!=="undefined"){title=title+" "+option}if(title.indexOf(" ")>0){var titleArr=title.split(" ");titleArr.forEach(function(word){fixedTitle=fixedTitle+word.capitalize()})}else{fixedTitle=title.capitalize()}return fixedTitle}}function buildObj(obj){var numValues=[],activeOptions=[],objValue=[];$.each(obj,function(title,valueObj){if(Array.isArray(valueObj)&&valueObj.length>-1){valueObj.forEach(function(option){if(option.isSelected===true){if(!isNaN(option.value)){numValues.push(option.value)}else if(option.value=="no value assigned"){activeOptions.push(option.text)}else if(typeof option.value==="string"){optObj={value:option.value,email:""};objValue.push(optObj)}}});if(numValues.length>0){isDropDown(title,numValues);numValues=[];return true}else if(activeOptions.length>0){noDropDown(title,activeOptions);activeOptions=[];return true}else if(objValue.length>0){isdynamicFilter(title,objValue);objValue=[];return true}}})}function isDropDown(title,values){var buildObj=new ISobjBuilder;buildObj.addProperty(buildObj.fixedPropertyName(title),values)}function noDropDown(title,options){var buildObj=new ISobjBuilder;options.forEach(function(optionName){buildObj.addProperty(buildObj.fixedPropertyName(title,optionName),true)})}function isdynamicFilter(title,options){var buildObj=new ISobjBuilder;buildObj.addProperty(buildObj.fixedPropertyName(title),options)}buildObj(obj);var IsObj=JSON.stringify(ISribbonObj);return IsObj}function filtersCollection($filter){$filter.each(function(){if($(this).attr("multiple")){handleMultiSelect($(this))}else if($(this).attr("data-select")==="default"){handleDefaultSelect($(this))}else if($(this).attr("data-dynamic")==="true"){handleDynamicSelect($(this))}else if($(this).find("select").length==0){handleNoSelectFilters($(this))}});ribbonWidgets.filterCollectorModule();initISfunc.run();return ribbonReqObj}function filterListener($rbWrapper){var isTimerRunning=false,ifMultipleClicks="";$(".sq-top-ribbon select").on("change",function(event){if(isTimerRunning){clearTimeout(ifMultipleClicks);isTimerRunning=true}else{isTimerRunning=true}ifMultipleClicks=setTimeout(function(){rebuildRibbonState($rbWrapper)},500)});$("#agile-status").find("li").on("click",function(e){e.preventDefault();rebuildRibbonState($rbWrapper)})}function passFilterStateObj(){return ribbonReqObj}function init(ISprocess){var $rbWrapper=$(".sq-top-ribbon"),$filter=$rbWrapper.find("[data-isFilter=true]");getISfunction(ISprocess);filtersCollection($filter);filterListener($rbWrapper);ribbonWidgets.filterCollectorModule();console.log(ribbonReqObj);console.log("ISobj: ",getISobj(ribbonReqObj))}return{init:init,rebuildRibbonState:rebuildRibbonState,passFilterStateObj:passFilterStateObj,getISobj:getISobj}}();var ribbonWidgets=function(){function PopoverHtmlBuilder(filter){this.msPopoverContent=String()+'<form class="dyn-select-form">'+'<div class="k-content">'+'<label for="popoverInput">'+filter+"</label>"+'<input id="popoverInput" />'+"</div>"+'<div class="panel panel-default taglist-parent" style="display:none;">'+'<div class="panel-body">'+'<div  unselectable="on">'+'<ul role="listbox" unselectable="on" class="k-reset" id="popoverInput_taglist_prev"></ul>'+"</div>"+"</div>"+"</div>"+'<button type="button" class="btn btn-default popOverbtn">Close</button>'+'<button type="button" class="btn btn-primary saveSelected">Apply</button>'+"</form>";this.msHtmlPopover=String()+'<div class="popover ribbon-popover" role="tooltip" >'+'<div class="arrow">'+"</div>"+'<h3 class="popover-title"></h3>'+'<div class="popover-content" >'+"</div>"+"</div>";return{content:this.msPopoverContent,tmpl:this.msHtmlPopover}}function ModalHtmlBuilder(modalInfo){this.modal=String()+'<div class="modal fade ribbon-modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">'+'<div class="modal-dialog" role="document">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title" id="myModalLabel">'+modalInfo.title+"</h4>"+"</div>"+'<div class="modal-body">'+modalInfo.content+"</div>"+'<div class="modal-footer">'+'<button type="submit" class="btn btn-default">Select</button>'+'<button type="reset" class="btn btn-default">Reset</button>'+"</div></div></div></div>";this.initModal=function(){$("body").append(this.modal)};this.show=function(){$("#myModal").modal("show")}}function ribbonPopupModule(){var targetInput="#popoverInput",popupTrigger=".popoverMS";function BuildDynamicSelect(wrapper){this.createSelectElem=function(){if($(wrapper).find(".dynamic-select").length==0){$(wrapper).append('<select class="dynamic-select" style="display:none">')}};this.createOption=function(option){$(wrapper).find(".dynamic-select").append('<option value="'+option.value+'">'+option.text+"</option>")};this.optionsCount=function(){var count=$(wrapper).find("option").length;return count};this.sanitizeLabel=function(label){var tagTxtArr=label.split(" ");tagTxtArr.pop();label=tagTxtArr.toString();return label};this.addCountToLabel=function(){var tagTxt=$(wrapper).find("span[data-title]").text();if(tagTxt.indexOf("(")>-1){tagTxt=this.sanitizeLabel(tagTxt);if(this.optionsCount()!==0){tagTxt=tagTxt+" ("+this.optionsCount()+")";$(wrapper).find("span[data-title]").text(tagTxt)}else{$(wrapper).find("span[data-title]").text(tagTxt)}}else{tagTxt=tagTxt+" ("+this.optionsCount()+")";$(wrapper).find("span[data-title]").text(tagTxt)}}}function initKendoMultiSelect(){$("#popoverInput").kendoMultiSelect({filter:"contains",separator:", ",placeholder:"Enter name...",minLength:2,dataSource:{transport:{read:{url:"/mk/singlequeue/widgets/views/data/users.json",datatype:"json"}},schema:{type:"json",data:"data"}},dataTextField:"Name",dataValueField:"Alias"})}function addPrevSelectionsToPopover(target){var $dynamicSelect=$(target).find(".dynamic-select");if($dynamicSelect.length>0){if($dynamicSelect.find("option").length>0){$(".taglist-parent").show()}$dynamicSelect.find("option").each(function(){var name=$(this).text();var temp=String()+'<li class="k-button" unselectable="on"><span unselectable="on">'+name+'</span><span unselectable="on" class="k-select">'+'<span unselectable="on" class="k-icon k-i-close remove-prev">delete</span></span></li>';$("#popoverInput_taglist_prev").append(temp)})}$(this).find("")}function removePrevOptions(target,option){var $dynamicSelect=$(target).find(".dynamic-select"),cleanTag=new BuildDynamicSelect(target);$dynamicSelect.find("option").each(function(){if($(this).text()==option){$(this).remove()}});if($dynamicSelect.find("option").length==0){$(".taglist-parent").hide("slow")}cleanTag.addCountToLabel()}function whichFilter(target){var ckFilter="";$(target).find("span").each(function(){if($(this).data("title")){ckFilter=$(this).data("title")}});return ckFilter}function closePopup(){$(popupTrigger).popover("destroy")}function saveSelected(){var $selctWrapper=$(targetInput).closest("li").find(popupTrigger),buildNewSelect=new BuildDynamicSelect($selctWrapper);if($(targetInput).find("option[selected]").length>0){buildNewSelect.createSelectElem();$(targetInput).find("option").each(function(){if($(this).attr("selected")){buildNewSelect.createOption(this)}});buildNewSelect.addCountToLabel();closePopup()}else{alert("Please select Owner name")}}$(popupTrigger).on("click",function(e){var buildHtml=new PopoverHtmlBuilder(whichFilter(this));$(this).popover({html:true,placement:"left",content:buildHtml.content,template:buildHtml.tmpl});$(this).popover("show");initKendoMultiSelect();addPrevSelectionsToPopover(this)});$("#filters-section").on("click",".popOverbtn",function(){ribbonListener.rebuildRibbonState($(".sq-top-ribbon"));closePopup()});$("#filters-section").on("click",".saveSelected",function(){saveSelected();ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))});$("#filters-section").on("click",".remove-prev",function(){var target=$(this).parents(".popover").siblings(popupTrigger),thisOption=$(this).parents("li.k-button"),thisName=thisOption.find("span").eq(0).text();removePrevOptions(target,thisName);thisOption.remove()})}function filterCollectorModule(){var filterObj=ribbonListener.passFilterStateObj();$(".filter-collector").html("");function findActiveFilters(){var activeFilters={};$.each(filterObj,function(filter,options){if(Array.isArray(options)){options.forEach(function(option){if(option.isSelected==true){if(filter in activeFilters){activeFilters[filter].push(option)}else{activeFilters[filter]=[];activeFilters[filter].push(option)}}})}});return activeFilters}function buildTmpl(activeFilters){$(".filter-collector").append("<ul><li>Filters:</li></ul>");var filterHtml="",activeArr=[];$.each(activeFilters,function(filter,options){filterHtml=String()+"<ul>"+"<li>"+filter+'<a href="#"> X</a></li>';if(Array.isArray(options)){options.forEach(function(option){filterHtml=filterHtml+"<li><span>"+option.text+'</span><a href="#"> X</a></li>'})}filterHtml=filterHtml+"</ul>";activeArr.push(filterHtml)});var cleanFilters=activeArr.join(" ");$(".filter-collector").append(cleanFilters)}function setXTrigger(){function updateMultiSelect(filterType,option){var updatedValues=[];if(option===undefined){$(filterType).multipleSelect("setSelects",[])}else{var optionValues=$(filterType).multipleSelect("getSelects"),optionTxt=$(filterType).multipleSelect("getSelects","text");optionTxt.forEach(function(optionTxt,index){if(option==optionTxt){updatedValues=optionValues.splice(index,1)}});$(filterType).multipleSelect("setSelects",optionValues)}}function updateDefaultSelect(filterType){$(filterType).val("0");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}function updateDynamicSelect(filterType,option){var $filterWrap=$(filterType).parent("a");if(option===undefined){$filterWrap.find("select").html("");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"));$(filterType).text($(filterType).data("title"))}else{$filterWrap.find("select option").each(function(){if($(this).text()==option){$(this).remove();ribbonListener.rebuildRibbonState($(".sq-top-ribbon"));editCountToLabel(filterType)}})}}function updateNoSelectFilters(filterType,option){if(option==undefined){$(filterType).find("li").each(function(){$(this).hasClass("active-item-bg")?$(this).removeClass("active-item-bg"):false});ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}else{$(filterType).find("li").each(function(){if($(this).find("a span:last-child").text()==option){$(this).removeClass("active-item-bg");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}})}}function findFilterTitle(clickedElm){var filterUl=$(clickedElm).closest("ul"),filterTxt=filterUl.find("li").eq(0).text(),filterTile=cleanFilterTxt(filterTxt);return filterTile}function findOptionTxt(clickedElm){var optionTxt=$(clickedElm).siblings("span").text();return optionTxt}function cleanFilterTxt(filter){var filterTypeArr=filter.split(" ");filterTypeArr.pop();filter=filterTypeArr.join(" ");return filter}function removeLabelParenthesis(label){var tagTxtArr=label.split(" ");tagTxtArr.pop();label=tagTxtArr.toString();return label}function editCountToLabel(filterType){var tagTxt=filterType.text(),optionCount=$(filterType).siblings("select").find("option").length;if(tagTxt.indexOf("(")>-1){tagTxt=removeLabelParenthesis(tagTxt);if(optionCount!==0){tagTxt=tagTxt+" ("+optionCount+")";$(filterType).text(tagTxt)}else{$(filterType).text(tagTxt)}}else{tagTxt=tagTxt+" ("+optionCount+")";$(filterType).text(tagTxt)}}function whichFilterType(filterType,option){if($(filterType).attr("multiple")){updateMultiSelect($(filterType),option)}else if($(filterType).attr("data-select")==="default"){updateDefaultSelect($(filterType))}else if($(filterType).parent("a").attr("data-dynamic")==="true"){updateDynamicSelect($(filterType),option)}else if($(filterType).find("select").length==0){updateNoSelectFilters($(filterType),option)}}$(".filter-collector").on("click","a",function(e){e.stopImmediatePropagation();e.preventDefault();var filterType=findFilterTitle($(this));if($(this).siblings("span").length>0){var optionTxt=findOptionTxt($(this));whichFilterType($('[data-title="'+filterType+'"]'),optionTxt)}else{whichFilterType($('[data-title="'+filterType+'"]'))}})}buildTmpl(findActiveFilters());setXTrigger()}function moreFiltersAutoComplete(){function runCampaignModal(){var campaignInfo={};campaignInfo.content=String()+"<div>"+'<form class="form-horizontal">'+'<div class="form-group">'+'<label for="campaignFilter">Campaign name: </label>'+'<input type="text" class="form-control" id="campaignFilter" placeholder="Campaign">'+'<div id="hidenDropdown" style="display: none"></div>'+"</div>"+"<p>Or</p>"+'<div class="form-group">'+'<label for="campaignFilter">Campaign Creator: </label>'+'<select  id="campaignCreator" placeholder="Campaign">'+addCreatorOptions()+"</select>"+"</div>"+"<p></p>"+'<select class="campFilterResults form-control" size="12" style="width:490px;"></select>'+"</form></div>";campaignInfo.title="Search Campaign";var buildModal=new ModalHtmlBuilder(campaignInfo);buildModal.initModal();buildModal.show();initCampaignAutoComplete("#campaignFilter");$("#campaignFilter").removeClass("k-input").parent().removeClass("k-widget k-autocomplete k-header form-control")}function initCampaignAutoComplete(id){var CampaignDataJSON="";function CampaignData_Get(){$.ajax({url:RootPath+"RequestQueues/CampaignData_Get",contentType:"application/json; charset=utf-8",success:function(response){if(response.error==""){CampaignDataJSON=response.data;console.log(CampaignDataJSON)}else{alert(response.error)}},error:function(){alert("Cannot load requests at this moment please try again later ")},async:true})}var dataSource=new kendo.data.DataSource({transport:{read:{url:"/mk/singlequeue/widgets/views/data/CampaignData_Get.json"}},schema:{data:"data"},change:function(e){var view=dataSource.view();console.log(view.length);console.log(view[0]);$(".campFilterResults").html("");for(var i=0;i<view.length;i++){$(".campFilterResults").append("<option>"+view[i].Name+"</option>")}}});$(id).kendoAutoComplete({dataSource:dataSource,dataTextField:"Name",popup:{appendTo:$("#hidenDropdown")},animation:false})}function addCreatorOptions(){var test=String()+"<option>"+"this option"+"</option>";for(var i=0;i<4;i++){test=test+test}return test}function projectFilter(){var dataSource="";$.get("/mk/singlequeue/widgets/views/data/ProjectData.js").done(function(){dataSource=projectsList();runFilter(dataSource)});function runFilter(data){$("#project-filter").kendoAutoComplete({dataSource:data,dataTextField:"Name"})}}$("#campaign-btn").on("click",function(e){runCampaignModal()})}return{ribbonPopupModule:ribbonPopupModule,filterCollectorModule:filterCollectorModule,moreFiltersAutoComplete:moreFiltersAutoComplete}}();$(function(){if($(".sq-top-ribbon").length===0){var timerOne=setInterval(function(){if($(".sq-top-ribbon").length>0){ribbonListener.init(ribbon_change);ribbonWidgets.ribbonPopupModule();ribbonWidgets.filterCollectorModule();ribbonWidgets.moreFiltersAutoComplete();clearInterval(timerOne)}},1e3)}});
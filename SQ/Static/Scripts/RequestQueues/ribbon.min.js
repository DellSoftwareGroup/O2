var ribbonListener=function(){var ribbonReqObj={};var isDoneLoading=false;function rebuildRibbonState($rbWrapper){var $filter=$($rbWrapper).find("[data-isFilter=true]");ribbonReqObj={};isDoneLoading=false;return filtersCollection($filter)}function handleMultiSelect($multiSelect,filterType){var hasActive=false,parentTag=$multiSelect.closest("li");if($multiSelect.data("title")!==null||$multiSelect.data("title")!==undefined){ribbonReqObj[$multiSelect.data("title")]=[]}else{console.error("Undefined filter title")}$multiSelect.next().find(".ms-drop li").each(function(){var $li=$(this);var option={};option.isSelected=function(){if($li.hasClass("selected")){if($li.parents(".sub-nav").length==0){parentTag.addClass("active-item-bg")}hasActive=true;return true}else{return false}}();option.value=$li.find("input").attr("value");option.text=$li.find("label").text();option.type=filterType;ribbonReqObj[$multiSelect.data("title")].push(option)});if(!hasActive){parentTag.removeClass("active-item-bg")}}function handleDefaultSelect(defaultSelect,filterType){if(defaultSelect.data("title")!==null||defaultSelect.data("title")!==undefined){ribbonReqObj[defaultSelect.data("title")]=[]}else{alert("No Title issue: see ribbon.js")}defaultSelect.find("option").each(function(){var $option=$(this);var option={};option.text=$option.text();option.value=$option.attr("value");option.type=filterType;option.isSelected=function(){if($option.attr("selected")){return true}else{return false}}();ribbonReqObj[defaultSelect.data("title")].push(option)})}function handleValueFromModal(whichModal,filtertype){var $thisModal=$(whichModal);var option={};ribbonReqObj[$thisModal.data("title")]=[];option.value=$thisModal.find("div:first-child").attr("filterid");option.text=$thisModal.find("div:first-child").text();option.isSelected=typeof option.value!="undefined"&&option.value!="";option.type=filtertype;ribbonReqObj[$thisModal.data("title")].push(option)}function handleNoSelectFilters(noSelect,filterType){var $prntLi=noSelect.parents("li"),prTitle=$prntLi.data("title");if(prTitle!==null||prTitle!==undefined){if(prTitle in ribbonReqObj){}else{ribbonReqObj[prTitle]=[]}}else{console.error("undefined title!!!")}var option={};option.text=noSelect.find("a span:last-child").text();option.value="no value assigned";option.type=filterType;option.isSelected=noSelect.hasClass("active-item-bg")?true:false;if(ribbonReqObj[prTitle].length>0){var tempArr=ribbonReqObj[prTitle].filter(function(obj){if(obj.text===option.text){return false}else{return true}});tempArr.push(option);ribbonReqObj[prTitle]=tempArr}else{ribbonReqObj[prTitle].push(option)}}function handleDynamicSelect(fromPopup,filterType){var filterTitle=$(fromPopup).find("[data-title]").data("title"),$dynamicSelectElem=$(fromPopup).find(".dynamic-select");if(filterTitle!==null||filterTitle!==undefined){ribbonReqObj[filterTitle]=[]}if($dynamicSelectElem.length>0){$dynamicSelectElem.find("option").each(function(){var $option=$(this);var option={};option.text=$option.text();option.value=$option.attr("value");option.email=$option.data("email");option.type=filterType;option.isSelected=true;ribbonReqObj[filterTitle].push(option)})}}function viewsSectionLogic(){var $checkBoxes=$("#views").find(".ms-drop").find("input"),views={active:""};function bindViewChanges(){$("#views").on("change.views",$checkBoxes,function(e){e.preventDefault();var $selected=$(e.target);if($selected.is("select")){views.clicked=getView($selected);if(views.clicked===views.active){if($($selected).multipleSelect("getSelects")==0){selectOppositeView(getView($selected))}else{return}}else{if($($selected).multipleSelect("getSelects")==0){return}clearOppositeView(getView($selected))}}})}function selectOppositeView(title){var oppositeView=title=="My Work"?"All Teams":"My Work";var $selectBack=$("#views").find('select[data-title="'+oppositeView+'"]');$selectBack.data("trigger","dynamic");views.active=oppositeView;$("#views").off(".views");$selectBack.multipleSelect("checkAll");$selectBack.parent("li").addClass("active-item-bg");bindViewChanges()}function clearOppositeView(title){if(title==undefined){return}else{var oppositeView=title=="My Work"?"All Teams":"My Work";var $selectOff=$("#views").find('select[data-title="'+oppositeView+'"]');$selectOff.data("trigger","dynamic");views.active=title;$("#views").off(".views");$selectOff.multipleSelect("setSelects",[]);$selectOff.parent("li").removeClass("active-item-bg");bindViewChanges()}}function getView(target){var title=$(target).data("title");$(target).parent("li").addClass("active-item-bg");return title}bindViewChanges()}function isFilterSecMultSelect(test){var $multiselect=$("#filters-section").find('select[multiple="multiple"]'),isFilter=false;$multiselect.each(function(){var title=$(this).data("title");if(test===title){isFilter=true}});return isFilter}function onCloseMultiSelectFilter($clicked){!!isFilterSecMultSelect($clicked)&&rebuildRibbonState(".sq-top-ribbon")}var initISfunc={};function getISfunction(funcPassed){initISfunc=function(){var passedFunc=funcPassed;function run(){if(typeof passedFunc!=="undefined"||typeof passedFunc!=="function"){passedFunc(getISobj(ribbonReqObj))}}return{passedFund:passedFunc,run:run}}()}function getISobj(uiObj){var ISribbonObj={},obj=uiObj==undefined?ribbonReqObj:uiObj;String.prototype.capitalize=function(){if(this.length>0){return this.charAt(0).toUpperCase()+this.slice(1)}};function ISobjBuilder(){this.addProperty=function(propertyName,values){ISribbonObj[propertyName]=values};this.fixedPropertyName=function(title,option){var fixedTitle="";if(typeof option!=="undefined"){title=title+" "+option}if(title.indexOf(" ")>0){var titleArr=title.split(" ");titleArr.forEach(function(word){if(typeof word=="string"){fixedTitle=fixedTitle+word.capitalize()}})}else{if(typeof title=="string"){fixedTitle=title.capitalize()}}return fixedTitle}}function buildObj(obj){var numValues=[],activeOptions=[],objValue=[];$.each(obj,function(title,valueObj){if(Array.isArray(valueObj)&&valueObj.length>-1){valueObj.forEach(function(option){if(option.isSelected===true){if(option.type=="array-list"){numValues.push(option.value)}else if(option.type=="boolean"){activeOptions.push(option.text)}else if(option.type==="userType"){optObj={value:option.value,email:option.email};objValue.push(optObj)}}});if(numValues.length>0){isDropDown(title,numValues);numValues=[];return true}else if(activeOptions.length>0){noDropDown(title,activeOptions);activeOptions=[];return true}else if(objValue.length>0){isdynamicFilter(title,objValue);objValue=[];return true}}})}function isDropDown(title,values){var buildObj=new ISobjBuilder;buildObj.addProperty(buildObj.fixedPropertyName(title),values)}function noDropDown(title,options){var buildObj=new ISobjBuilder;options.forEach(function(optionName){buildObj.addProperty(buildObj.fixedPropertyName(title,optionName),true)})}function isdynamicFilter(title,options){var buildObj=new ISobjBuilder;buildObj.addProperty(buildObj.fixedPropertyName(title),options)}if($.isEmptyObject(obj)){console.error("empty object -- see func isdynamicFilter");return false}else{buildObj(obj);var IsObj=JSON.stringify(ISribbonObj);return IsObj}}function filtersCollection($filter){$filter.each(function(){if($(this).attr("multiple")){handleMultiSelect($(this),"array-list")}else if($(this).attr("data-select")==="default"){handleDefaultSelect($(this),"array-list")}else if($(this).attr("data-dynamic")==="true"){handleDynamicSelect($(this),"userType")}else if($(this).attr("filter-type")==="from-modal"){handleValueFromModal($(this),"array-list")}else if($(this).find("select").length==0){handleNoSelectFilters($(this),"boolean")}});ribbonWidgets.filterCollectorModule();initISfunc.run();return ribbonReqObj}function filterListener($rbWrapper){var isTimerRunning=false,ifMultipleClicks="",isLoop=0;$(".sq-top-ribbon").on("change","select",function(event){var $target=$(event.target);var filterRibonTriggered=$target.data("trigger");if(isFilterSecMultSelect($target.data("title"))){if(filterRibonTriggered!=="dynamic"){return}else{if(isLoop>0){isLoop=0;return}$target.data("trigger","");isLoop++}}if(isTimerRunning){clearTimeout(ifMultipleClicks)}ifMultipleClicks=setTimeout(function(){rebuildRibbonState($rbWrapper);isTimerRunning=true},500)});$("#agile-status").on("click","a",function(e){e.preventDefault();toggleActiveItem($(this).parent("li"));rebuildRibbonState($rbWrapper)});$("#dp-sprint-dd").find("option:first-child").text("All Sprints")}function passFilterStateObj(){return ribbonReqObj}function init(ISprocess){var $rbWrapper=$(".sq-top-ribbon"),$filter=$rbWrapper.find("[data-isFilter=true]");getISfunction(ISprocess);filtersCollection($filter);filterListener($rbWrapper);viewsSectionLogic()}return{isDoneLoading:isDoneLoading,init:init,rebuildRibbonState:rebuildRibbonState,onCloseMultiFilter:onCloseMultiSelectFilter,passFilterStateObj:passFilterStateObj,isFilterSecMultSelect:isFilterSecMultSelect,getISobj:getISobj}}();var ribbonWidgets=function(){function filterCollectorModule(){var filterObj=ribbonListener.passFilterStateObj();$(".filter-collector").html("");function findActiveFilters(){var activeFilters={};$.each(filterObj,function(filter,options){if(Array.isArray(options)){options.forEach(function(option){if(option.isSelected==true){if(filter in activeFilters){activeFilters[filter].push(option)}else{activeFilters[filter]=[];activeFilters[filter].push(option)}}})}});return activeFilters}function buildTmpl(activeFilters){$(".filter-collector").append("<ul><li>Filters:</li></ul>");var filterHtml="",activeArr=[];$.each(activeFilters,function(filter,options){filterHtml=String()+"<ul>"+"<li>"+filter+'<a href="#"> X</a></li>';if(Array.isArray(options)){options.forEach(function(option){filterHtml=filterHtml+"<li><span>"+option.text+"</span></li>"})}filterHtml=filterHtml+"</ul>";activeArr.push(filterHtml)});var cleanFilters=activeArr.join(" ");$(".filter-collector").append(cleanFilters)}function setXTrigger(){function updateMultiSelect(filterType,option){var updatedValues=[];if(option===undefined){$(filterType).data("trigger","dynamic");$(filterType).multipleSelect("setSelects",[])}else{var optionValues=$(filterType).multipleSelect("getSelects"),optionTxt=$(filterType).multipleSelect("getSelects","text");optionTxt.forEach(function(optionTxt,index){if(option==optionTxt){updatedValues=optionValues.splice(index,1)}});$(filterType).data("trigger","dynamic");$(filterType).multipleSelect("setSelects",optionValues)}}function updateDefaultSelect(filterType){$("#dp-sprint-dd").val("");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}function updateDynamicSelect(filterType,option){var $filterWrap=$(filterType).parent("a");if(option===undefined){$filterWrap.find("select").html("");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"));$(filterType).text($(filterType).data("title"))}else{$filterWrap.find("select option").each(function(){if($(this).text()==option){$(this).remove();ribbonListener.rebuildRibbonState($(".sq-top-ribbon"));editCountToLabel(filterType)}})}}function updateOptionFromModal(filterType){var $thisModal=$(filterType);$thisModal.find("div:first-child").attr("filterid","");$thisModal.find("div:first-child").html("<span>"+$thisModal.data("title")+"</span>");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}function updateNoSelectFilters(filterType,option){if(option==undefined){$(filterType).find("li").each(function(){$(this).hasClass("active-item-bg")?$(this).removeClass("active-item-bg"):false});ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}else{$(filterType).find("li").each(function(){if($(this).find("a span:last-child").text()==option){$(this).removeClass("active-item-bg");ribbonListener.rebuildRibbonState($(".sq-top-ribbon"))}})}}function findFilterTitle(clickedElm){var filterUl=$(clickedElm).closest("ul"),filterTxt=filterUl.find("li").eq(0).text(),filterTile=cleanFilterTxt(filterTxt);return filterTile}function findOptionTxt(clickedElm){var optionTxt=$(clickedElm).siblings("span").text();return optionTxt}function cleanFilterTxt(filter){var filterTypeArr=filter.split(" ");filterTypeArr.pop();filter=filterTypeArr.join(" ");return filter}function removeLabelParenthesis(label){var tagTxtArr=label.split(" ");tagTxtArr.pop();label=tagTxtArr.toString();return label}function editCountToLabel(filterType){var tagTxt=filterType.text(),optionCount=$(filterType).siblings("select").find("option").length;if(tagTxt.indexOf("(")>-1){tagTxt=removeLabelParenthesis(tagTxt);if(optionCount!==0){tagTxt=tagTxt+" ("+optionCount+")";$(filterType).text(tagTxt)}else{$(filterType).text(tagTxt)}}else{tagTxt=tagTxt+" ("+optionCount+")";$(filterType).text(tagTxt)}}function whichFilterType(filterType,option){if($(filterType).attr("multiple")){updateMultiSelect($(filterType),option)}else if($(filterType).attr("data-select")==="default"){updateDefaultSelect($(filterType))}else if($(filterType).parent("a").attr("data-dynamic")==="true"){updateDynamicSelect($(filterType),option)}else if($(filterType).attr("filter-type")==="from-modal"){updateOptionFromModal($(filterType))}else if($(filterType).find("select").length==0){updateNoSelectFilters($(filterType),option)}}$(".filter-collector").on("click","a",function(e){e.preventDefault();var filterType=findFilterTitle($(this));var $dataTitle=$(".sq-top-ribbon").find('[data-title="'+filterType+'"]');if($(this).siblings("span").length>0){var optionTxt=findOptionTxt($(this));whichFilterType($dataTitle,optionTxt)}else{whichFilterType($dataTitle)}})}buildTmpl(findActiveFilters());setXTrigger()}var moreFiltersPopover=function(){function onModalInputchange($modalName){var changeIcon=function(){$("#filter-"+$modalName).find("#"+$modalName+"-btn").addClass("hidden").end().find("> span").removeClass("hidden")},callRibbonListener=function(){ribbonListener.rebuildRibbonState(".sq-top-ribbon")};$.when(changeIcon()).done(callRibbonListener())}function init(){$(".sub-nav").on("click",".clear-btn",function(){var thisParent=$(this).parent("div");$(this).siblings("div").attr("filterid","").html("<span>"+thisParent.data("title")+"</span>").end().addClass("hidden").siblings("input[type=button]").removeClass("hidden");ribbonListener.rebuildRibbonState(".sq-top-ribbon")})}return{init:init,onModalInputchange:onModalInputchange}}();return{filterCollectorModule:filterCollectorModule,moreFiltersPopover:moreFiltersPopover}}();
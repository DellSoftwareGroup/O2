String.prototype.capitalize=function(){if(this.length>0){return this.charAt(0).toUpperCase()+this.slice(1)}};var ribbonElem=null,moreFiltersElem=null;var initRibbon=function(){function splitCamelCase(word){return word.replace(/([A-Z])/g," $1").replace(/^./,function(str){return str.toUpperCase()})}function getOption(word){var obj={};var rem=word.split(" ");obj.option=rem.pop();obj.title=rem.join(" ");return obj}function getFilterInfo(filterType){var whichFilter=$.trim(filterType.data("title"));return filtersMap[whichFilter]}var $filters=[],filtersMap={},activeFilters={};function findActiveFilters(lastFiltersObj){if(!$.isEmptyObject(lastFiltersObj)){this.init(lastFiltersObj)}else{console.warn("No ribbon cookie information found!")}}function processActiveFilters(filterObj){function getFilterTitle(){var filterTitles=[];$.each(filterObj,function(prop,val){var title=$.trim(splitCamelCase(prop));if(title.indexOf("Request Status")>-1){var info=getOption(title);title=info.title;if(title in filtersMap){var arr=filtersMap[title]["option"];arr.push(info.option);val=arr}else{arr=[];arr.push(info.option);val=arr;title=info.title}}if(filterTitles.length==0){filterTitles.push(title)}else{var titleExist=false;filterTitles.forEach(function(eTitle){if(eTitle==title){titleExist=true}});!titleExist&&filterTitles.push(title)}filtersMap[title]={option:val,original:prop}});return filterTitles}var filterTitles=getFilterTitle();$.each(filterTitles,function(indx,title){var elem=ribbonElem.find('[data-title = "'+title+'"]');if(elem){$filters.push(elem)}});function typeOfFilter(){ribbonElem.find(".active-item-bg").removeClass("active-item-bg");$filters.forEach(function(filterType){var filterInfo=getFilterInfo(filterType);if(filterType.attr("multiple")){filterType.multipleSelect("setSelects",filterInfo.option);if(filterInfo.option.length){filterType.parents("li").addClass("active-item-bg")}}else if(filterType.data("title")=="Request Status"){setSimpleNoSelectFilters(filterType,filterInfo.option)}else if(filterType.parent("a").attr("data-dynamic")==="true"){setDynamicFilters(filterType,filterInfo.option)}})}function setSimpleNoSelectFilters(multiSelct,options){$(multiSelct).find("li").each(function(){var $li=$(this);options.forEach(function(option){if(!!$li.find('a[title="'+option+'"]').length){$li.addClass("active-item-bg")}})})}function setDynamicFilters(multiSelct,options){var $li=$(multiSelct).closest("li"),$select=$li.find("select");if(options.length){options.forEach(function(option){$select.append('<option value="'+option.value+'" data-name="'+option.name+'">'+option.name+"</option>")});$li.addClass("active-item-bg")}}return{typeOfFilter:typeOfFilter}}function init(filterObj){activeFilters=processActiveFilters(filterObj);activeFilters.typeOfFilter()}function filterStatus(enable){var ribbonLis=ribbonElem.find("> ul").find("> li");ribbonLis.each(function(i){if(i){if(enable){$(this).removeClass("disabled")}else{$(this).addClass("disabled")}}});ribbonElem.find("select").each(function(){if($(this).attr("multiple")=="multiple"){if(enable){$(this).multipleSelect("enable")}else{$(this).multipleSelect("disable")}}})}return{init:init,findActiveFilters:findActiveFilters,enable:filterStatus}}();var ribbonListener=function(){var ribbonReqObj={},filtersMap={},isDoneLoading=false,initISfunc={},filters=null;function rebuildRibbonState(){ribbonReqObj={};isDoneLoading=false;return filtersCollection()}function handleMultiSelect($multiSelect,filterType){var arr=[];$multiSelect.find("option").each(function(){var isSelected=false;if($(this).prop("selected")){setActiveFilter($multiSelect);isSelected=true}arr.push({type:filterType,isSelected:isSelected,value:$(this).attr("value"),text:$(this).text()})});return arr}function handleDefaultSelect(defaultSelect,filterType){var arr=[];defaultSelect.find("option").each(function(){var $option=$(this);arr.push({text:$option.text(),value:$option.attr("value"),type:filterType,isSelected:$option.prop("selected")})});return arr}function handleDefaultText(elem,filterType){return{text:elem.val(),value:"no value assigned",type:filterType,isSelected:true}}function handleValueFromModal(whichModal,filterType){var arr=[],option={value:whichModal.find("div:first-child").attr("filterid"),text:whichModal.find("div:first-child").text(),type:filterType};option.isSelected=function(){if(typeof option.value!="undefined"&&option.value!=""){setActiveFilter(whichModal);return true}return false}();arr.push(option);return arr}function handleNoSelectFilters(noSelect,filterType){return{text:noSelect.find("a span:last-child").text(),value:"no value assigned",type:filterType,isSelected:noSelect.hasClass("active-item-bg")?true:false}}function handleDynamicSelect(fromPopup,filterType){var arr=[],$dynamicSelectElem=fromPopup.siblings(".dynamic-select");if($dynamicSelectElem.length>0){if($dynamicSelectElem.find("option").length){fromPopup.parent().addClass("active-item-bg");$dynamicSelectElem.find("option").each(function(){var $option=$(this);arr.push({text:$option.text(),value:$option.attr("value"),name:$option.data("name"),type:filterType,isSelected:true})})}}return arr}function viewsSectionLogic(){var $checkBoxes=$("#views").find(".ms-drop").find("input"),views={active:""};function bindViewChanges(){$("#views").on("change.views",$checkBoxes,function(e){e.preventDefault();var $selected=$(e.target);if($selected.is("select")){views.clicked=getView($selected);if(views.clicked===views.active){if($($selected).multipleSelect("getSelects")==0){selectOppositeView(getView($selected))}else{return}}else{if($($selected).multipleSelect("getSelects")==0){return}clearOppositeView(getView($selected))}}});views.active=$("#views").find(".active-item-bg").find("> select").data("title")}function selectOppositeView(title){var oppositeView=title=="My Work"?"All Teams":"My Work";var $selectBack=$("#views").find('select[data-title="'+oppositeView+'"]');$selectBack.data("trigger","dynamic");views.active=oppositeView;$("#views").off(".views");$selectBack.multipleSelect("checkAll");$selectBack.parent("li").addClass("active-item-bg");bindViewChanges()}function clearOppositeView(title){if(title==undefined){return}else{var oppositeView=title=="My Work"?"All Teams":"My Work",$selectOff=$("#views").find('select[data-title="'+oppositeView+'"]');$selectOff.data("trigger","dynamic");views.active=title;$("#views").off(".views");$selectOff.multipleSelect("setSelects",[]);$selectOff.parent("li").removeClass("active-item-bg");bindViewChanges()}}function getView(target){$(target).parent("li").addClass("active-item-bg");return $(target).data("title")}bindViewChanges()}function setActiveFilter(target){target.closest("li").addClass("active-item-bg")}function getISfunction(funcPassed){initISfunc=function(){var passedFunc=funcPassed;function run(){if(typeof passedFunc!=="undefined"||typeof passedFunc!=="function"){passedFunc(getISobj(ribbonReqObj))}}return{passedFund:passedFunc,run:run}}()}function getISobj(uiObj,raw){var ISribbonObj={},obj=uiObj===undefined?ribbonReqObj:uiObj;raw=raw||false;function ISobjBuilder(){this.addProperty=function(propertyName,values){ISribbonObj[propertyName]=values};this.fixedPropertyName=function(title,option){var fixedTitle="";if(typeof option!=="undefined"){title=title+" "+option}if(title.indexOf(" ")>0){var titleArr=title.split(" ");titleArr.forEach(function(word){if(typeof word=="string"){fixedTitle=fixedTitle+word.capitalize()}})}else{if(typeof title=="string"){fixedTitle=title.capitalize()}}return fixedTitle}}function buildObj(obj){$.each(obj,function(title,valueObj){var numValues=[],activeOptions=[],objValue=[],textOption="";if(Array.isArray(valueObj)&&valueObj.length>-1){valueObj.forEach(function(option){if(option.isSelected===true){if(option.type=="array-list"){numValues.push(option.value)}else if(option.type=="boolean"){activeOptions.push(option.text)}else if(option.type==="userType"){objValue.push({value:option.value,name:option.name})}else if(option.type=="date"){textOption=option.text}}else{allSelected=false}});var buildObj=new ISobjBuilder;if(numValues.length>0){buildObj.addProperty(buildObj.fixedPropertyName(title),numValues)}else if(activeOptions.length>0){activeOptions.forEach(function(text){buildObj.addProperty(buildObj.fixedPropertyName(title,text),true)})}else if(objValue.length>0){buildObj.addProperty(buildObj.fixedPropertyName(title),objValue)}else if(textOption!=""){buildObj.addProperty(buildObj.fixedPropertyName(title),textOption)}}})}if($.isEmptyObject(obj)){console.error("empty object");return false}else{buildObj(obj);if(!raw){$.each(ISribbonObj,function(n,v){if(n=="Sprint"){ISribbonObj[n]=function(){var allSprintSelected=false,unassignedSprintSelected=false;var newArr=ISribbonObj[n].filter(function(value,index,arr){if(value==""){allSprintSelected=true}else if(value=="UNASSIGNED"){unassignedSprintSelected=true}else if(allSprintSelected&&value!="UNASSIGNED"){return false}return true});if(allSprintSelected){if(unassignedSprintSelected){return null}else{newArr[0]=null}}return newArr}();if(ISribbonObj[n]===null){delete ISribbonObj[n]}}else if(typeof filtersMap[n]!=="undefined"&&filtersMap[n].data("aon-same")!==false&&filtersMap[n].attr("type")=="select"){if(v.length==filtersMap[n].find("option").length){delete ISribbonObj[n]}}})}return ISribbonObj}}function filtersCollection(){if(filters===null){filters=ribbonElem.find("[data-isFilter=true]");filters.each(function(){var title=$(this).data("title")||$(this).parents("li").data("title");filtersMap[title.replace(/\s/g,"")]=$(this)})}filters.parents("li").removeClass("active-item-bg");filters.each(function(){var title=$(this).data("title")||$(this).parents("li").data("title");if(typeof ribbonReqObj[title]=="undefined"&&(title!==null||title!==undefined)){ribbonReqObj[title]=[]}if($(this).attr("multiple")){ribbonReqObj[title]=handleMultiSelect($(this),"array-list")}else if($(this).attr("data-select")==="default"){ribbonReqObj[title]=handleDefaultSelect($(this),"array-list")}else if($(this).attr("data-dynamic")==="true"){ribbonReqObj[title]=handleDynamicSelect($(this),"userType")}else if($(this).attr("filter-type")==="from-modal"){ribbonReqObj[title]=handleValueFromModal($(this),"array-list")}else if($(this).hasClass("date-picker")){ribbonReqObj[title].push(handleDefaultText($(this),"date"))}else if($(this).find("select").length==0){ribbonReqObj[title].push(handleNoSelectFilters($(this),"boolean"))}});ribbonWidgets.filterCollectorModule();var cookieName=ribbonElem.data("cookie");if(cookieName){$.cookie(cookieName,JSON.stringify(ribbonListener.getISobj(undefined,true)),{path:"/"})}if(ribbonElem.data("auto-update")){initISfunc.run()}else{ribbonElem.trigger("filter.change",getISobj(ribbonReqObj,false))}return ribbonReqObj}function filterListener($rbWrapper){$rbWrapper.on("click",".toggle-switch a",function(e){e.preventDefault();if(!$("#agile-status").hasClass("disabled")){toggleActiveItem($(this).parent("li"));rebuildRibbonState()}}).on("click",".reset-filter",function(){$rbWrapper.find("select").filter("[multiple=multiple]").each(function(){$(this).multipleSelect("uncheckAll").parents("li").removeClass("active-item-bg")});$.each(filters,function(indx,elem){if($(elem).attr("multiple")){$(elem).multipleSelect("uncheckAll").parents("li").removeClass("active-item-bg")}else{$(elem).val("")}});rebuildRibbonState()}).on("click",".execute-filter",function(){setTimeout(function(){initISfunc.run()})})}function passFilterStateObj(){return ribbonReqObj}function init(ISprocess){getISfunction(ISprocess);filtersCollection();filterListener(ribbonElem);viewsSectionLogic()}return{isDoneLoading:isDoneLoading,init:init,rebuildRibbonState:rebuildRibbonState,passFilterStateObj:passFilterStateObj,getISobj:getISobj}}();var ribbonWidgets=function(){var plugins={};function addPlugin(pluginName,fn){plugins[pluginName]=fn}function filterCollectorModule(){var filterObj=ribbonListener.passFilterStateObj(),filterCollectorElem=$(".filter-collector"),interactiveFilter=filterCollectorElem.data("interactive")===undefined||filterCollectorElem.data("interactive");function findActiveFilters(){var activeFilters={};$.each(filterObj,function(filter,options){if(Array.isArray(options)){var tmpData={allSelected:true,data:[]};options.forEach(function(option){if(option.isSelected){tmpData.data.push(option)}else{tmpData.allSelected=false}if(option.type=="date"){tmpData.allSelected=false}});if(tmpData.data.length){activeFilters[filter]=tmpData}}});return activeFilters}function buildTmpl(activeFilters){if(plugins["buildTmplBefore"]){activeFilters=plugins["buildTmplBefore"].call(this,activeFilters)}filterCollectorElem.find("ul.dynamic").remove();var filterHtml="",activeArr=[];$.each(activeFilters,function(filterName,filterObj){filterHtml='<ul class="dynamic"><li>'+filterName;if(interactiveFilter){filterHtml+='<a href="#" data-title="'+filterName+'"> X</a>'}filterHtml+="</li>";if(typeof filterObj=="string"){filterHtml+="<li><span>"+filterObj+"</span></li>"}else{if(filterObj.allSelected){filterHtml+="<li><span>All</span></li>"}else{filterObj.data.forEach(function(option){filterHtml+="<li><span>"+option.text+"</span></li>"})}}filterHtml+="</ul>";activeArr.push(filterHtml)});filterCollectorElem.append(activeArr.join(" "))}function buildTmplNew(activeFilters){filterCollectorElem.addClass("new");filterCollectorElem.find("> ul").empty();filterCollectorElem.find("> ul").append('<li><span>Clear All Filters <a href="#" data-action="clear-cookie"> X</a></span><div>This will clear all filters and restore to your user preference.</div></li>');var filterHtml="";$.each(activeFilters,function(filter,options){filterHtml="<li><span>"+filter+'<a href="#" data-title="'+filter+'"> X</a></span>';if(Array.isArray(options)){filterHtml+="<div>";options.forEach(function(option){filterHtml+="<span>"+option.text+"</span>"});filterHtml+="</div>"}filterHtml+="</li>";filterCollectorElem.find("> ul").append(filterHtml)})}function setXTrigger(){function updateMultiSelect(filterType,option){if(option===undefined){$(filterType).data("trigger","dynamic").multipleSelect("setSelects",[])}else{var updatedValues=[],optionValues=$(filterType).multipleSelect("getSelects"),optionTxt=$(filterType).multipleSelect("getSelects","text");optionTxt.forEach(function(optionTxt,index){if(option==optionTxt){updatedValues=optionValues.splice(index,1)}});$(filterType).data("trigger","dynamic").multipleSelect("setSelects",optionValues)}}function updateDefaultSelect(filterType){$("#dp-sprint-dd").val("")}function updateDynamicSelect(filterType,option){var $filterWrap=$(filterType).parent("a");if(option===undefined){$filterWrap.siblings("select").html("");$(filterType).text($(filterType).data("title"))}else{$filterWrap.parent().addClass("active-item-bg");$filterWrap.siblings("select option").each(function(){if($(this).text()==option){$(this).remove()}})}}function updateOptionFromModal(filterType){var $thisModal=$(filterType);$thisModal.find("div:first-child").attr("filterid","");$thisModal.find("div:first-child").html("<span>"+$thisModal.data("title")+"</span>")}function updateNoSelectFilters(filterType,option){if(option==undefined){}else{}}function findOptionTxt(clickedElm){return $(clickedElm).siblings("span").text()}function cleanFilterTxt(filter){var filterTypeArr=filter.split(" ");filterTypeArr.pop();filter=filterTypeArr.join(" ");return filter}function removeLabelParenthesis(label){var tagTxtArr=label.split(" ");tagTxtArr.pop();label=tagTxtArr.toString();return label}function editCountToLabel(filterType){var tagTxt=filterType.text(),optionCount=$(filterType).siblings("select").find("option").length;if(tagTxt.indexOf("(")>-1){tagTxt=removeLabelParenthesis(tagTxt);if(optionCount!==0){$(filterType).text(tagTxt)}else{$(filterType).text(tagTxt)}}else{$(filterType).text(tagTxt)}}function whichFilterType(filterType,option){if(filterType.parents("li").length){filterType.parents("li").removeClass("active-item-bg")}else{filterType.find(".active-item-bg").removeClass("active-item-bg")}if(filterType.attr("multiple")){updateMultiSelect(filterType,option)}else if(filterType.attr("data-select")==="default"){updateDefaultSelect(filterType)}else if(filterType.parent("a").attr("data-dynamic")==="true"){updateDynamicSelect(filterType,option)}else if(filterType.attr("filter-type")==="from-modal"){updateOptionFromModal(filterType)}}if(!filterCollectorElem.data("initialize")){filterCollectorElem.data("initialize",true);filterCollectorElem.on("click","a",function(e){e.preventDefault();if($(this).data("action")=="clear-cookie"){initRibbon.findActiveFilters(ribbonWidgets.userPreferences());ribbonListener.rebuildRibbonState();return}var filterType=$(this).data("title"),$dataTitle=ribbonElem.find('[data-title="'+filterType+'"]');if($(this).siblings("span").length>0){var optionTxt=findOptionTxt($(this));whichFilterType($dataTitle,optionTxt)}else{whichFilterType($dataTitle)}ribbonListener.rebuildRibbonState()});if(location.search=="?v2"){filterCollectorElem.popover({html:true,placement:"bottom",selector:"li",trigger:"hover",viewport:".filter-collector",title:"",content:function(){return $(this).find("> div").html()}})}}}if(location.search=="?v2"){buildTmplNew(findActiveFilters())}else{buildTmpl(findActiveFilters())}setXTrigger()}function getUserPreferences(){if(typeof UserPreferences=="undefined"){return false}var obj={};if($.isEmptyObject(UserPreferences)){obj.MyWork=[1,2];obj.RequestStatusIdea=true;obj.RequestStatusBacklog=true;obj.RequestStatusStarted=true}else{if(UserPreferences.MyWorkList!=null){if(UserPreferences.RQL_ViewPreference=="All Team"){obj.AllTeams=UserPreferences.MyWorkList}else{obj.MyWork=UserPreferences.MyWorkList}}if(UserPreferences.DepartmentList!=null){obj.Departments=UserPreferences.DepartmentList}if(UserPreferences.RequestStatusList!=null){$.each(UserPreferences.RequestStatusList,function(indx,val){obj["RequestStatus"+requestStatuses[val].charAt(0).toUpperCase()+requestStatuses[val].substr(1)]=true})}}return obj}var moreFiltersPopover=function(){function onModalInputchange($modalName){var changeIcon=function(){$("#filter-"+$modalName).find("#"+$modalName+"-btn").addClass("hidden").end().find("> span").removeClass("hidden")},callRibbonListener=function(){ribbonListener.rebuildRibbonState()};$.when(changeIcon()).done(callRibbonListener())}function init(){ribbonElem.on("click",".clear-btn",function(){var thisParent=$(this).parent("div");$(this).siblings("div").attr("filterid","").html("<span>"+thisParent.data("title")+"</span>").end().addClass("hidden").siblings("input[type=button]").removeClass("hidden");ribbonListener.rebuildRibbonState()})}return{init:init,onModalInputchange:onModalInputchange}}();return{filterCollectorModule:filterCollectorModule,moreFiltersPopover:moreFiltersPopover,userPreferences:getUserPreferences,addPlugin:addPlugin}}();function toggleActiveItem(elem){$(elem).toggleClass("active-item-bg").end().removeClass("disable-hover")}function doSearch(){var GridType=$("#GridType").val(),searchFilterElem=$(".search-filter-collector"),searchField=$("#search-query");query=searchField.val().trim();if(query==""){return}searchField.val("");if(GridViewType=="calendar"){ReloadCalendar()}else if(GridViewType=="list"||GridViewType=="list-edit"){ReloadGrid(0)}else if(GridViewType=="list-edit-legacy"){ReloadLegacyRequestsGrid()}initRibbon.enable(false);$(".filter-collector").hide();searchFilterElem.find(".search-query-display").text(query).end().show();if(!searchFilterElem.data("initialize")){searchFilterElem.on("click","a",function(e){e.preventDefault();query="";initRibbon.enable(true);$(".filter-collector").show();searchFilterElem.hide();if(GridViewType=="calendar"){ReloadCalendar()}else if(GridViewType=="list"||GridViewType=="list-edit"){ReloadGrid(0)}else if(GridViewType=="list-edit-legacy"){ReloadLegacyRequestsGrid()}});searchFilterElem.data("initialize",true)}}$(function(){ribbonElem=$(".sq-top-ribbon");if(ribbonElem.length){moreFiltersElem=ribbonElem.find(".has-dropdown");ribbonElem.on("click",".ms-parent",function(e){e.stopPropagation()});if(moreFiltersElem.length){moreFiltersElem.on("click","> a",function(e){e.preventDefault();e.stopPropagation();if(!$(this).parents(".disabled").length){$(this).parent().toggleClass("open")}}).on("click","> div",function(e){if(!$(e.target).hasClass("clear-btn")){e.stopPropagation()}})}ribbonElemMS=ribbonElem.find("select").filter("[multiple=multiple]");ribbonElemMS.each(function(){var title=$(this).data("title");$(this).multipleSelect({placeholder:title,minimumCountSelected:0,countSelected:title,selectAllText:$(this).data("select-all-text"),allSelected:title,maxHeight:240,onClose:function(){var currentValues=this.target.multipleSelect("getSelects");if($(this.previousValues).not(currentValues).length!==0||$(currentValues).not(this.previousValues).length!==0){ribbonListener.rebuildRibbonState()}},onOpen:function(elem){this.target=$(elem).parent().prev();this.previousValues=this.target.multipleSelect("getSelects");var nextElem=$(elem).next(),ul=nextElem.find("ul");if(!nextElem.find(".btn").length&&ribbonElem.data("auto-update")){nextElem.append('<div class="mt-10 mb-10 text-right"><button class="btn btn-default mr-10">Reset</button><button class="btn btn-primary mr-10">Apply</button></div>');nextElem.on("click",".btn-default",function(){$(elem).parents(".ms-parent").prev().multipleSelect("uncheckAll")});nextElem.on("click",".btn-primary",function(){$(this).parents(".ms-parent").prev().multipleSelect("close")})}if(ul.outerHeight()<ul.prop("scrollHeight")&&!ul.data("width-fixed")){ul.css("width",ul.outerWidth()+$.position.scrollbarWidth()).data("width-fixed",true)}nextElem.css("right","auto");if(nextElem.offset().left+nextElem.find("ul").outerWidth(true)>$("body").width()){nextElem.css("right",0)}var selectTagElem=$(elem).parent().prev().get(0);ribbonElemMS.each(function(){if(selectTagElem!=this){var elem=$(this).next();elem.find(".ms-choice").find("> div").removeClass("open").end().next().hide()}})}})});$("html, body").on("click",function(e){if(moreFiltersElem.length){moreFiltersElem.removeClass("open")}if($(e.target).parent().find(".toggle-popover").length>0){$(".toggle-popover").popover("hide")}ribbonElem.find(".ms-parent").each(function(){if($(this).find(".open").length){$(this).prev().data("multipleSelect").options.onClose();$(this).find(".open").removeClass("open").end().find(".ms-drop").hide()}})});ribbonElem.find("> ul > li").matchHeight();(function(){var cookieName=ribbonElem.data("cookie");if(cookieName){var sessionFilterSettings=$.cookie(cookieName);if(sessionFilterSettings){initRibbon.findActiveFilters($.parseJSON(sessionFilterSettings))}else{initRibbon.findActiveFilters(ribbonWidgets.userPreferences())}}})();ribbonElem.addClass("initialized");if(ribbonElem.data("search")){$("#search-container").addClass("initialized")}}});